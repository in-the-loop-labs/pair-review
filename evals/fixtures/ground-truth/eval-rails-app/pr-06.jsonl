{"id": "06-001", "file": "app/models/task.rb", "line_start": 28, "line_end": 30, "type": "performance", "severity": "medium", "title": "LIKE query on title and description without database index", "description": "The search scope uses ILIKE with leading wildcards (e.g., '%query%') on title and description columns, but there is no database index to support this pattern. Leading-wildcard LIKE queries cannot use standard B-tree indexes, so every search will perform a full table scan. For a growing task table, this becomes increasingly slow.", "hint": "Add a GIN index with pg_trgm extension for trigram-based ILIKE support, or use PostgreSQL full-text search with a tsvector column and GIN index."}
{"id": "06-002", "file": "app/models/task.rb", "line_start": 28, "line_end": 33, "type": "improvement", "severity": "low", "title": "Hand-rolled ILIKE search should use pg_search gem", "description": "The search implementation uses raw ILIKE queries, which is a common but fragile approach. It doesn't handle relevance ranking, stemming, or stop words. The pg_search gem provides proper full-text search backed by PostgreSQL's tsvector, with relevance ranking and much better performance out of the box.", "hint": "Consider using the pg_search gem with its pg_search_scope for proper full-text search with relevance ranking."}
{"id": "06-003", "file": "app/models/task.rb", "line_start": 28, "line_end": 33, "type": "code-style", "severity": "medium", "title": "Raw SQL in search scopes violates Active Record convention", "description": "Both the search scope (line 29: raw SQL WHERE with ILIKE) and by_status_text scope (line 32: raw SQL with PostgreSQL type cast '::text') use raw SQL strings instead of Active Record query methods. The project's CONTRIBUTING.md explicitly requires 'Active Record scopes (no raw SQL)'. The by_status_text scope is particularly problematic as it uses PostgreSQL-specific casting syntax, making the code database-dependent.", "hint": "Use Arel or Active Record query methods. For search, consider using .where(Task.arel_table[:title].matches(...)) or the pg_search gem. For status filtering, use the existing enum scope .by_status instead of raw SQL casting."}
{"id": "06-004", "file": "app/models/task.rb", "line_start": 28, "line_end": 30, "type": "bug", "severity": "low", "title": "Search scope does not handle nil query gracefully", "description": "Calling Task.search(nil) will generate a query with '%nil%' interpolated, or potentially raise an error depending on how the parameter is passed. The scope assumes query is always a non-nil string. When called from the controller, params[:q] could be nil if the parameter is present but empty in certain edge cases.", "hint": "Add a nil/blank guard in the scope, e.g., return all if query is blank, or add a .presence check before calling the scope."}
{"id": "06-005", "file": "app/controllers/tasks_controller.rb", "line_start": 25, "line_end": 25, "type": "performance", "severity": "medium", "title": "Unnecessary eager loading of associations for search results", "description": "The index action eager-loads :project, :user, and :notifications via .includes, but the task index view only displays task title, status, priority, user name, and due date. The :notifications association is never accessed in the view, resulting in unnecessary database queries loading all notifications for every listed task. The :project is already available as @project.", "hint": "Remove :notifications from the includes call. Since @project is already loaded, :project may also be unnecessary depending on the view implementation."}
{"id": "06-006", "file": "app/controllers/tasks_controller.rb", "line_start": 13, "line_end": 23, "type": "code-style", "severity": "low", "title": "Inconsistent filter parameter naming convention", "description": "The filter parameters use three different naming conventions: params[:q] for text search, params[:status_filter] for status (with a _filter suffix), and params[:priority] for priority (bare name). This inconsistency extends to the view where the form fields use matching but inconsistent names. Parameters should follow a consistent convention.", "hint": "Standardize on a consistent naming scheme: either all bare names (q, status, priority), all with filter prefix (filter_q, filter_status, filter_priority), or use a nested params hash (filter[q], filter[status], filter[priority])."}
{"id": "06-007", "file": "app/controllers/tasks_controller.rb", "line_start": 8, "line_end": 27, "type": "design", "severity": "medium", "title": "Search and filtering logic belongs in model or service, not controller", "description": "The index action builds up a complex query chain with multiple conditional .where clauses for search, status filtering, and priority filtering. This violates the project's convention of keeping controllers thin and putting business logic in models (scopes) or service objects. The filtering logic should be encapsulated in a model scope like Task.filter_by(params) or extracted to a TaskSearchService.", "hint": "Create a composite scope on Task (e.g., scope :filter_by) that accepts a hash of filter parameters and chains the appropriate conditions, or extract a TaskSearchService class following the project's service object convention."}
{"id": "06-008", "file": "app/models/task.rb", "line_start": 31, "line_end": 33, "type": "bug", "severity": "medium", "title": "Dead by_status_text scope has broken semantics and no consumers", "description": "The by_status_text scope casts the status column to ::text and compares with ILIKE, but the status column is an integer enum â€” casting to text yields digit strings like '0', '1', not the human-readable names. This scope is never called anywhere in the codebase, so it is dead code with broken semantics that will confuse future developers.", "hint": "Remove the by_status_text scope entirely. If text-based status filtering is needed, use the enum's built-in scope (e.g., Task.by_status('in_progress')) which handles the mapping correctly."}
{"id": "06-009", "file": "app/models/task.rb", "line_start": 29, "line_end": 29, "type": "security", "severity": "medium", "title": "ILIKE search vulnerable to wildcard injection", "description": "User input is interpolated directly into an ILIKE pattern without sanitizing LIKE special characters (%, _, \\). A user can craft a search query containing these characters to manipulate the pattern matching behavior, potentially causing unexpected results or performance degradation through expensive pattern matching.", "hint": "Use ActiveRecord::Base.sanitize_sql_like(query) to escape LIKE special characters before interpolating into the pattern."}
{"id": "06-010", "file": "app/controllers/tasks_controller.rb", "type": "security", "severity": "low", "title": "Strong params permits :admin which is not a task attribute", "description": "The task_params method permits an :admin parameter, but the tasks table has no admin column. While Rails will silently ignore unknown attributes during mass assignment, permitting a non-existent parameter in strong params suggests a copy-paste error or security oversight. If an admin column is ever added to tasks, this would immediately become a mass-assignment vulnerability.", "hint": "Remove :admin from the permitted parameters list.", "is_file_level": true}
{"id": "06-011", "file": "spec/models/task_spec.rb", "line_start": 95, "line_end": 95, "type": "improvement", "severity": "low", "title": "Search specs use weak assertions that don't verify exclusion", "description": "The search scope tests use include() matchers which only verify that expected results are present, but do not verify that non-matching records are excluded. This means the tests would pass even if the search scope returned all records unfiltered. Stronger assertions would use eq() or match_array() to verify both inclusion and exclusion.", "hint": "Use expect(results).to eq([expected_task]) or match_array([expected_task]) instead of include(expected_task), and add explicit not_to include assertions for records that should be excluded."}
