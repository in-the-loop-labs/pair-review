# SPDX-License-Identifier: GPL-3.0-or-later
name: GitHub Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: notes
        run: |
          # Extract the section for this version from CHANGELOG.md
          # Matches from "## X.Y.Z" until the next "## " or end of file
          VERSION="${{ steps.version.outputs.version }}"

          # Use awk to extract the section
          NOTES=$(awk -v ver="$VERSION" '
            /^## / {
              if (found) exit
              if ($2 == ver || $2 == "["ver"]") found=1
              next
            }
            found { print }
          ' CHANGELOG.md)

          # Write to file to preserve newlines
          echo "$NOTES" > release-notes.md

          # Debug output
          echo "Extracted notes for version $VERSION:"
          cat release-notes.md

      - name: Create GitHub Release
        run: |
          gh release create "$GITHUB_REF_NAME" \
            --title "$GITHUB_REF_NAME" \
            --notes-file release-notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
