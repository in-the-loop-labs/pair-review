# SPDX-License-Identifier: GPL-3.0-or-later
name: GitHub Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.1)'
        required: true

permissions:
  contents: write

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Determine tag
        id: tag
        run: |
          # Use input tag for workflow_dispatch, otherwise use GITHUB_REF_NAME
          TAG="${{ inputs.tag || github.ref_name }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag }}

      - name: Extract release notes from CHANGELOG
        id: notes
        run: |
          # Extract the section for this version from CHANGELOG.md
          # Matches from "## X.Y.Z" until the next "## " or end of file
          VERSION="${{ steps.tag.outputs.version }}"

          # Use awk to extract the section
          NOTES=$(awk -v ver="$VERSION" '
            /^## / {
              if (found) exit
              if ($2 == ver || $2 == "["ver"]") found=1
              next
            }
            found { print }
          ' CHANGELOG.md)

          # Write to file to preserve newlines
          echo "$NOTES" > release-notes.md

          # Debug output
          echo "Extracted notes for version $VERSION:"
          cat release-notes.md

      - name: Create GitHub Release
        run: |
          gh release create "${{ steps.tag.outputs.tag }}" \
            --title "${{ steps.tag.outputs.tag }}" \
            --notes-file release-notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
